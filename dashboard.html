<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
    <style>
        #main-content {
            display: block;
            width: 100%;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: block;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            margin-bottom: 20px;
        }
        header h1 {
            margin: 0;
        }
        #dashboard-container {
            display: block;
        }
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
        }
        select:focus {
            outline: none;
            border-color: #2196F3;
        }
    </style>
</head>
<body>
    <div id="main-content">
        <header>
            <h1>üìä Dashboard de Opera√ß√µes: Conta Pessoal vs Mesa Propriet√°ria</h1>
        </header>

        <div class="container">
            <!-- Seletor de Modo -->
            <div class="mode-selector">
                <select id="modeSelect" onchange="switchMode()">
                    <option value="personal">Conta Pessoal</option>
                    <option value="prop">Mesa Propriet√°ria</option>
                </select>
            </div>

            <div class="tabs">
                <button class="tab-button active" data-tab="overview">Vis√£o Geral</button>
                <button class="tab-button" data-tab="evolution">Evolu√ß√£o</button>
            </div>

            <div id="overview" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="metric-card">
                        <h3>Capital Dispon√≠vel</h3>
                        <div class="value" id="availableCapital">R$ 0,00</div>
                        <div class="period-results">
                            <span id="dailyChange">Hoje: R$ 0,00</span>
                            <span id="weeklyChange">Semana: R$ 0,00</span>
                            <span id="monthlyChange">M√™s: R$ 0,00</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3>Resultado Total</h3>
                        <div class="value" id="totalResult">R$ 0,00</div>
                        <div class="status-message" id="statusMessage">Status</div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3>Taxa de Acerto</h3>
                        <div class="value" id="winRate">0%</div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3 id="lastMetricTitle">Valor que Falta para o Teste</h3>
                        <div class="value" id="avgResult">R$ 0,00</div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Registrar Opera√ß√£o</h2>
                    <form id="tradeForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="date">Data</label>
                                <input type="date" id="date" required>
                            </div>
                            <div class="form-group">
                                <label for="asset">Ativo</label>
                                <select id="asset" required>
                                    <option value="">Selecione...</option>
                                    <option value="WDO">WDO</option>
                                    <option value="WIN">WIN</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="operationType">Tipo de Opera√ß√£o</label>
                                <select id="operationType" required>
                                    <option value="">Selecione...</option>
                                    <option value="buy">Compra</option>
                                    <option value="sell">Venda</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="analysisType">Tipo de An√°lise</label>
                                <select id="analysisType" required>
                                    <option value="">Selecione...</option>
                                    <option value="auction">Leil√£o</option>
                                    <option value="opening">Abertura</option>
                                    <option value="exhaustion">Cansa√ßo de movimento</option>
                                    <option value="test">Teste</option>
                                    <option value="moving_averages">Cruzamento de m√©dias</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="contracts">Contratos</label>
                                <input type="number" id="contracts" required>
                            </div>
                            <div class="form-group">
                                <label for="entryPrice">Pre√ßo de Entrada</label>
                                <input type="number" id="entryPrice" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="exitPrice">Pre√ßo de Sa√≠da</label>
                                <input type="number" id="exitPrice" step="0.01" required>
                            </div>
                            <!-- Campos espec√≠ficos por modo -->
                            <div id="personalFields" class="mode-fields" style="display: none;">
                                <div class="form-group">
                                    <label for="capital">Capital Dispon√≠vel</label>
                                    <input type="number" id="capital" value="10000" required>
                                </div>
                            </div>
                            <div id="propFields" class="mode-fields">
                                <div class="form-group">
                                    <label for="propCapital">Meta para Aprova√ß√£o</label>
                                    <input type="number" id="propCapital" value="5000" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="operationNotes">Observa√ß√µes</label>
                                <textarea id="operationNotes" rows="3" required></textarea>
                            </div>
                        </div>
                        <div class="button-group">
                            <button type="submit" class="primary">Registrar Opera√ß√£o</button>
                            <button type="button" class="secondary" id="generateReport">Gerar Relat√≥rio</button>
                            <button type="button" class="secondary" onclick="clearStorage()">Limpar Dados</button>
                        </div>
                    </form>
                </div>

                <div class="filter-section">
                    <div class="filter-grid">
                        <div class="form-group">
                            <label for="startDate">Data Inicial</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="form-group">
                            <label for="endDate">Data Final</label>
                            <input type="date" id="endDate">
                        </div>
                        <div class="form-group">
                            <button type="button" class="primary" id="applyFilters">Aplicar Filtros</button>
                        </div>
                    </div>
                </div>

                <!-- Nova se√ß√£o de an√°lise de pre√ßos -->
                <div class="price-analysis-section" style="margin: 20px 0; padding: 20px; background-color: #f5f5f5; border-radius: 8px;">
                    <h3>An√°lise de Regi√£o de Pre√ßo</h3>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <div class="form-group">
                            <label for="priceSearch">Pre√ßo</label>
                            <input type="number" id="priceSearch" step="0.01" placeholder="Ex: 5711.00">
                        </div>
                        <div class="form-group">
                            <label for="assetSearch">Ativo</label>
                            <input type="text" id="assetSearch" placeholder="Ex: WDO">
                        </div>
                        <button type="button" class="primary" onclick="analyzePriceRegion()">Analisar</button>
                    </div>
                    <div id="priceAnalysisResult" style="margin-top: 15px; padding: 15px; border-radius: 4px;"></div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>Data</th>
                            <th>Modo</th>
                            <th>Ativo</th>
                            <th>Tipo</th>
                            <th>An√°lise</th>
                            <th>Contratos</th>
                            <th>Entrada</th>
                            <th>Sa√≠da</th>
                            <th>Resultado</th>
                            <th>Capital</th>
                            <th>Observa√ß√µes</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTableBody"></tbody>
                </table>
            </div>

            <div id="evolution" class="tab-content">
                <div class="evolution-grid">
                    <canvas id="resultChart"></canvas>
                    <canvas id="equityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let trades = [];

        // Vari√°veis globais para os gr√°ficos
        window.resultChart = null;
        window.equityChart = null;

        function getFilteredTrades() {
            try {
                const trades = JSON.parse(localStorage.getItem('trades') || '[]');
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const mode = document.getElementById('modeSelect').value;

                // Se n√£o houver datas selecionadas, retornar todas as opera√ß√µes do modo atual
                if (!startDate && !endDate) {
                    return trades.filter(trade => trade.mode === mode);
                }

                // Se houver datas, aplicar o filtro
                return trades.filter(trade => {
                    const modeMatch = trade.mode === mode;
                    const tradeDate = new Date(trade.date);
                    const isAfterStart = !startDate || tradeDate >= new Date(startDate);
                    const isBeforeEnd = !endDate || tradeDate <= new Date(endDate);

                    return modeMatch && isAfterStart && isBeforeEnd;
                });
            } catch (error) {
                console.error('Erro ao filtrar trades:', error);
                return [];
            }
        }

        function deleteTrade(index) {
            try {
                if (confirm('Tem certeza que deseja apagar esta opera√ß√£o?')) {
                    // Carregar trades atuais
                    let trades = JSON.parse(localStorage.getItem('trades') || '[]');
                    
                    // Remover o trade pelo √≠ndice
                    trades.splice(index, 1);
                    
                    // Salvar trades atualizados
                    localStorage.setItem('trades', JSON.stringify(trades));
                    
                    // Atualizar interface
                    updateDashboard();
                    updateCharts();
                    updateOperationsTable();
                    
                    alert('Opera√ß√£o apagada com sucesso!');
                }
            } catch (error) {
                console.error('Erro ao apagar opera√ß√£o:', error);
                alert('Erro ao apagar a opera√ß√£o. Por favor, tente novamente.');
            }
        }

        function updateOperationsTable() {
            try {
                const filteredTrades = getFilteredTrades();
                const tbody = document.getElementById('tradesTableBody');
                tbody.innerHTML = '';

                // Remover bot√µes antigos se existirem
                const oldActionButtons = document.querySelector('.table-actions');
                if (oldActionButtons) {
                    oldActionButtons.remove();
                }

                // Adicionar bot√µes de a√ß√£o em massa acima da tabela
                const actionButtons = document.createElement('div');
                actionButtons.className = 'table-actions';
                actionButtons.style.margin = '10px 0';
                actionButtons.innerHTML = `
                    <button onclick="selectAllTrades()" class="secondary">Selecionar Todos</button>
                    <button onclick="unselectAllTrades()" class="secondary">Desmarcar Todos</button>
                    <button onclick="deleteSelectedTrades()" class="delete-button" style="background-color: #ff4444; color: white; padding: 5px 10px; border-radius: 4px;">
                        Apagar Selecionados
                    </button>
                `;
                tbody.parentElement.parentElement.insertBefore(actionButtons, tbody.parentElement);

                if (filteredTrades.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="13" style="text-align: center;">Nenhuma opera√ß√£o registrada</td>';
                    tbody.appendChild(row);
                    return;
                }

                // Ordenar trades por data (ordem crescente)
                const sortedTrades = filteredTrades.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

                sortedTrades.forEach((trade, index) => {
                    const row = document.createElement('tr');
                    
                    // Calcular pontos
                    const points = trade.points || (trade.operationType === 'buy' 
                        ? (trade.exitPrice - trade.entryPrice)
                        : (trade.entryPrice - trade.exitPrice));
                    
                    // Formatar valores
                    const formattedDate = formatDate(trade.date);
                    const formattedEntryPrice = formatCurrency(trade.entryPrice);
                    const formattedExitPrice = formatCurrency(trade.exitPrice);
                    const formattedResult = formatCurrency(trade.result);
                    const formattedCapital = formatCurrency(trade.capital);
                    
                    // Definir classe para o resultado
                    const resultClass = points >= 0 ? 'positive' : 'negative';
                    
                    row.innerHTML = `
                        <td style="text-align: center;">
                            <input type="checkbox" class="trade-checkbox" data-index="${index}">
                        </td>
                        <td style="text-align: center;">${formattedDate}</td>
                        <td style="text-align: center;">${trade.mode === 'personal' ? 'Conta Pessoal' : 'Mesa Propriet√°ria'}</td>
                        <td style="text-align: center;">${trade.asset.toUpperCase()}</td>
                        <td style="text-align: center;">${getOperationTypeName(trade.operationType)}</td>
                        <td style="text-align: center;">${getAnalysisTypeName(trade.analysisType)}</td>
                        <td style="text-align: right;">${trade.contracts}</td>
                        <td style="text-align: right;">${formattedEntryPrice}</td>
                        <td style="text-align: right;">${formattedExitPrice}</td>
                        <td class="${resultClass}" style="text-align: right;">
                            ${formattedResult}
                            <br>
                            <small style="color: ${points >= 0 ? 'green' : 'red'}">
                                ${Math.abs(points)} pts
                            </small>
                        </td>
                        <td style="text-align: right;">${formattedCapital}</td>
                        <td style="text-align: left;">${trade.operationNotes || ''}</td>
                        <td style="text-align: center;">
                            <div style="display: flex; gap: 5px; justify-content: center;">
                                <button onclick="generateTradePDF(${index})" class="pdf-button" title="Gerar PDF">üìÑ</button>
                                <button onclick="deleteTrade(${index})" class="delete-button" title="Apagar registro" style="color: red; cursor: pointer;">üóëÔ∏è</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                console.log('Tabela de opera√ß√µes atualizada com sucesso');
            } catch (error) {
                console.error('Erro ao atualizar tabela de opera√ß√µes:', error);
                alert('Erro ao atualizar a tabela de opera√ß√µes. Por favor, recarregue a p√°gina.');
            }
        }

        // Fun√ß√µes para manipula√ß√£o em massa
        function selectAllTrades() {
            const checkboxes = document.querySelectorAll('.trade-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        }

        function unselectAllTrades() {
            const checkboxes = document.querySelectorAll('.trade-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        function deleteSelectedTrades() {
            const checkboxes = document.querySelectorAll('.trade-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Selecione pelo menos uma opera√ß√£o para apagar.');
                return;
            }

            if (confirm(`Tem certeza que deseja apagar ${checkboxes.length} opera√ß√£o(√µes)?`)) {
                try {
                    // Destruir gr√°ficos antes de atualizar
                    if (window.resultChart) {
                        window.resultChart.destroy();
                        window.resultChart = null;
                    }
                    if (window.equityChart) {
                        window.equityChart.destroy();
                        window.equityChart = null;
                    }

                    // Carregar todos os trades
                    let trades = JSON.parse(localStorage.getItem('trades') || '[]');
                    
                    // Obter os √≠ndices dos trades selecionados
                    const indexesToDelete = Array.from(checkboxes)
                        .map(cb => parseInt(cb.getAttribute('data-index')))
                        .sort((a, b) => b - a);

                    // Remover os trades selecionados
                    indexesToDelete.forEach(index => {
                        trades.splice(index, 1);
                    });

                    // Salvar os trades atualizados
                    localStorage.setItem('trades', JSON.stringify(trades));
                    
                    // Atualizar a interface
                    updateOperationsTable();
                    updateDashboard();
                    updateCharts();
                    
                    alert('Opera√ß√µes selecionadas foram apagadas com sucesso!');
                } catch (error) {
                    console.error('Erro ao apagar opera√ß√µes:', error);
                    alert('Erro ao apagar as opera√ß√µes. Por favor, tente novamente.');
                }
            }
        }

        function updateCharts() {
            const filteredTrades = getFilteredTrades();

            // Se n√£o houver trades, criar gr√°ficos vazios
            if (!filteredTrades || filteredTrades.length === 0) {
                createEmptyCharts();
                return;
            }

            // Destruir gr√°ficos existentes
            if (window.resultChart) {
                window.resultChart.destroy();
                window.resultChart = null;
            }
            if (window.equityChart) {
                window.equityChart.destroy();
                window.equityChart = null;
            }

            // Criar gr√°fico de resultados
            const resultCtx = document.getElementById('resultChart').getContext('2d');
            window.resultChart = new Chart(resultCtx, {
                type: 'bar',
                data: {
                    labels: filteredTrades.map(t => formatDate(t.date)),
                    datasets: [{
                        label: 'Resultado por Opera√ß√£o',
                        data: filteredTrades.map(t => t.result),
                        backgroundColor: filteredTrades.map(t => t.result >= 0 ? '#4CAF50' : '#f44336')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Criar gr√°fico de equity
            const equityCtx = document.getElementById('equityChart').getContext('2d');
            const equity = filteredTrades.reduce((acc, trade) => {
                const lastValue = acc.length > 0 ? acc[acc.length - 1] : trade.capital;
                acc.push(lastValue + trade.result);
                return acc;
            }, [filteredTrades[0]?.capital || 0]);

            window.equityChart = new Chart(equityCtx, {
                type: 'line',
                data: {
                    labels: filteredTrades.map(t => formatDate(t.date)),
                    datasets: [{
                        label: 'Evolu√ß√£o do Capital',
                        data: equity,
                        borderColor: '#2196F3',
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function switchTab(tab) {
            // Remover classe active de todas as tabs e conte√∫dos
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Adicionar classe active na tab selecionada
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        function getOperationTypeName(type) {
            return type === 'buy' ? 'Compra' : 'Venda';
        }

        function getAnalysisTypeName(type) {
            const types = {
                'auction': 'Leil√£o',
                'opening': 'Abertura',
                'exhaustion': 'Cansa√ßo de movimento',
                'test': 'Teste',
                'moving_averages': 'Cruzamento de m√©dias'
            };
            return types[type] || type;
        }

        function getMotivationalMessage(points, isProfit) {
            points = Math.abs(points); // Converter para n√∫mero positivo para a mensagem
            
            if (isProfit) {
                if (points >= 20) return `üåü EXTRAORDIN√ÅRIO! Voc√™ fez ${points} pontos! Continue assim!`;
                if (points >= 10) return `üéØ EXCELENTE! Voc√™ conquistou ${points} pontos!`;
                if (points >= 5) return `‚ú® Muito bem! Voc√™ fez ${points} pontos!`;
                return `üëç Boa! Voc√™ fez ${points} pontos!`;
            } else {
                if (points >= 20) return `üòî Ops! Voc√™ perdeu ${points} pontos. Respire, analise e volte mais forte!`;
                if (points >= 10) return `‚ö†Ô∏è Aten√ß√£o! Perda de ${points} pontos. Revise sua estrat√©gia!`;
                if (points >= 5) return `üìä Voc√™ perdeu ${points} pontos. Mantenha o foco!`;
                return `‚ö° Perda de ${points} pontos. Continue tentando!`;
            }
        }

        function updateDashboard() {
            try {
                const mode = document.getElementById('modeSelect').value;
                const propCapital = parseFloat(document.getElementById('propCapital').value) || 5000;
                
                // Atualizar t√≠tulo e valor do capital baseado no modo
                if (mode === 'prop') {
                    document.querySelector('.metric-card:first-child h3').textContent = 'Capital Dispon√≠vel';
                    document.getElementById('availableCapital').textContent = formatCurrency(propCapital);
                    document.getElementById('availableCapital').style.color = 'black';
                    document.getElementById('lastMetricTitle').textContent = 'Valor que Falta para o Teste';
                } else {
                    document.querySelector('.metric-card:first-child h3').textContent = 'Capital Dispon√≠vel';
                    document.getElementById('availableCapital').textContent = formatCurrency(parseFloat(document.getElementById('capital').value) || 10000);
                    document.getElementById('availableCapital').style.color = 'black';
                    document.getElementById('lastMetricTitle').textContent = 'M√©dia por Opera√ß√£o';
                }

                // Carregar todas as opera√ß√µes
                const trades = JSON.parse(localStorage.getItem('trades') || '[]');
                const filteredTrades = trades.filter(trade => trade.mode === mode);
                
                // Se n√£o houver opera√ß√µes, mostrar valores zerados
                if (!filteredTrades || filteredTrades.length === 0) {
                    document.getElementById('totalResult').textContent = 'R$ 0,00';
                    document.getElementById('totalResult').style.color = 'black';
                    document.getElementById('winRate').textContent = '0,00%';
                    document.getElementById('winRate').style.color = 'black';
                    document.getElementById('dailyChange').textContent = 'Hoje: R$ 0,00';
                    document.getElementById('dailyChange').style.color = 'black';
                    document.getElementById('weeklyChange').textContent = 'Semana: R$ 0,00';
                    document.getElementById('weeklyChange').style.color = 'black';
                    document.getElementById('monthlyChange').textContent = 'M√™s: R$ 0,00';
                    document.getElementById('monthlyChange').style.color = 'black';
                    document.getElementById('statusMessage').textContent = 'Nenhuma opera√ß√£o registrada';
                    document.getElementById('statusMessage').style.color = 'black';

                    if (mode === 'prop') {
                        document.getElementById('avgResult').textContent = formatCurrency(propCapital);
                        document.getElementById('avgResult').style.color = 'black';
                    } else {
                        document.getElementById('avgResult').textContent = 'R$ 0,00';
                        document.getElementById('avgResult').style.color = 'black';
                    }
                    return;
                }

                // Calcular resultados
                const currentDate = new Date();
                const today = new Date().toISOString().split('T')[0];
                const startOfWeek = new Date(currentDate.setDate(currentDate.getDate() - currentDate.getDay())).toISOString().split('T')[0];
                const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString().split('T')[0];

                const totalResult = filteredTrades.reduce((sum, trade) => sum + (trade.result || 0), 0);
                const monthlyResult = filteredTrades.filter(trade => trade.date >= startOfMonth).reduce((sum, trade) => sum + (trade.result || 0), 0);
                const weeklyResult = filteredTrades.filter(trade => trade.date >= startOfWeek).reduce((sum, trade) => sum + (trade.result || 0), 0);
                const dailyResult = filteredTrades.filter(trade => trade.date === today).reduce((sum, trade) => sum + (trade.result || 0), 0);

                const totalTrades = filteredTrades.length;
                const winningTrades = filteredTrades.filter(trade => trade.result > 0).length;
                const winRate = ((winningTrades / totalTrades) * 100).toFixed(2);

                // Atualizar valores no dashboard
                document.getElementById('totalResult').textContent = formatCurrency(totalResult);
                document.getElementById('totalResult').style.color = totalResult >= 0 ? 'green' : 'red';
                
                document.getElementById('winRate').textContent = `${winRate}%`;
                document.getElementById('winRate').style.color = parseFloat(winRate) >= 50 ? 'green' : 'red';

                document.getElementById('dailyChange').textContent = `Hoje: ${formatCurrency(dailyResult)}`;
                document.getElementById('dailyChange').style.color = dailyResult >= 0 ? 'green' : 'red';
                
                document.getElementById('weeklyChange').textContent = `Semana: ${formatCurrency(weeklyResult)}`;
                document.getElementById('weeklyChange').style.color = weeklyResult >= 0 ? 'green' : 'red';
                
                document.getElementById('monthlyChange').textContent = `M√™s: ${formatCurrency(monthlyResult)}`;
                document.getElementById('monthlyChange').style.color = monthlyResult >= 0 ? 'green' : 'red';

                // Atualizar valor que falta para o teste ou m√©dia por opera√ß√£o
                if (mode === 'prop') {
                    const valorQueFalta = propCapital - monthlyResult;
                    document.getElementById('avgResult').textContent = formatCurrency(valorQueFalta);
                    document.getElementById('avgResult').style.color = monthlyResult >= 0 ? 'green' : 'red';

                    // Verificar status do teste
                    if (monthlyResult >= propCapital) {
                        document.getElementById('statusMessage').textContent = 'PARAB√âNS! TUDO INDICA QUE VOC√ä PASSOU NO SEU TESTE!';
                        document.getElementById('statusMessage').style.color = 'green';
                    } else if (monthlyResult <= -propCapital) {
                        document.getElementById('statusMessage').textContent = 'POXA, AO QUE PARECE VOC√ä ATINGIU O LOSS GLOBAL DO SEU TESTE.';
                        document.getElementById('statusMessage').style.color = 'red';
                    } else {
                        document.getElementById('statusMessage').textContent = monthlyResult >= 0 ? 'üéØ Voc√™ est√° lucrando!' : '‚ö†Ô∏è Aten√ß√£o aos resultados!';
                        document.getElementById('statusMessage').style.color = monthlyResult >= 0 ? 'green' : 'red';
                    }
                } else {
                    const avgResult = totalTrades > 0 ? (totalResult / totalTrades) : 0;
                    document.getElementById('avgResult').textContent = formatCurrency(avgResult);
                    document.getElementById('avgResult').style.color = avgResult >= 0 ? 'green' : 'red';
                    
                    document.getElementById('statusMessage').textContent = totalResult >= 0 ? 'üéØ Voc√™ est√° lucrando!' : '‚ö†Ô∏è Aten√ß√£o aos resultados!';
                    document.getElementById('statusMessage').style.color = totalResult >= 0 ? 'green' : 'red';
                }

                // Atualizar gr√°ficos
                updateCharts();

            } catch (error) {
                console.error('Erro ao atualizar dashboard:', error);
            }
        }

        function handleTradeSubmit(e) {
            if (e) e.preventDefault();
            
            try {
                const mode = document.getElementById('modeSelect').value;
                const date = document.getElementById('date').value;
                const asset = document.getElementById('asset').value;
                const operationType = document.getElementById('operationType').value;
                const analysisType = document.getElementById('analysisType').value;
                const contracts = parseInt(document.getElementById('contracts').value);
                const entryPrice = parseFloat(document.getElementById('entryPrice').value);
                const exitPrice = parseFloat(document.getElementById('exitPrice').value);
                const operationNotes = document.getElementById('operationNotes').value;

                // Valida√ß√µes b√°sicas
                if (!date || !asset || !operationType || !analysisType) {
                    alert('Por favor, preencha todos os campos obrigat√≥rios.');
                    return false;
                }

                if (!contracts || !entryPrice || !exitPrice || contracts <= 0 || entryPrice <= 0 || exitPrice <= 0) {
                    alert('Por favor, insira valores v√°lidos para contratos e pre√ßos.');
                    return false;
                }

                // Criar objeto trade
                const trade = {
                    date: date,
                    mode: mode,
                    asset: asset.toUpperCase(),
                    operationType: operationType,
                    analysisType: analysisType,
                    contracts: contracts,
                    entryPrice: entryPrice,
                    exitPrice: exitPrice,
                    operationNotes: operationNotes
                };

                // Calcular pontos e resultado
                const points = trade.operationType === 'buy' 
                    ? (trade.exitPrice - trade.entryPrice)
                    : (trade.entryPrice - trade.exitPrice);
                
                trade.result = points * trade.contracts * 10;
                trade.points = points;

                // Adicionar dados do modo
                if (mode === 'personal') {
                    trade.capital = parseFloat(document.getElementById('capital').value) || 10000;
                } else {
                    trade.capital = parseFloat(document.getElementById('propCapital').value) || 5000;
                }

                // Salvar a opera√ß√£o
                let trades = JSON.parse(localStorage.getItem('trades') || '[]');
                trades.push(trade);
                localStorage.setItem('trades', JSON.stringify(trades));

                // Atualizar interface
                updateOperationsTable();
                updateDashboard();
                updateCharts();

                // Limpar formul√°rio manualmente
                document.getElementById('date').valueAsDate = new Date();
                document.getElementById('asset').value = '';
                document.getElementById('operationType').value = '';
                document.getElementById('analysisType').value = '';
                document.getElementById('contracts').value = '';
                document.getElementById('entryPrice').value = '';
                document.getElementById('exitPrice').value = '';
                document.getElementById('operationNotes').value = '';

                // Manter valores do modo atual
                if (mode === 'prop') {
                    document.getElementById('propCapital').value = trade.capital;
                }

                // Mensagem de sucesso
                const isProfit = trade.result > 0;
                const message = getMotivationalMessage(Math.abs(points), isProfit);
                alert(message);

                return false;
            } catch (error) {
                console.error('Erro ao registrar:', error);
                alert('Erro ao registrar. Verifique o console para detalhes.');
                return false;
            }
        }

        function setupEventListeners() {
            const tradeForm = document.getElementById('tradeForm');
            
            // Remover event listeners existentes
            const newTradeForm = tradeForm.cloneNode(true);
            tradeForm.parentNode.replaceChild(newTradeForm, tradeForm);
            
            // Adicionar novo event listener
            newTradeForm.addEventListener('submit', handleTradeSubmit);

            // Event listener para o bot√£o de aplicar filtros
            document.getElementById('applyFilters').addEventListener('click', function() {
                updateOperationsTable();
                updateDashboard();
                updateCharts();
            });

            // Event listeners para as tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tab = this.dataset.tab;
                    switchTab(tab);
                    if (tab === 'evolution') {
                        updateCharts();
                    }
                });
            });

            // Event listener para mudan√ßa de modo
            document.getElementById('modeSelect').addEventListener('change', function() {
                const mode = this.value;
                document.getElementById('personalFields').style.display = mode === 'personal' ? 'block' : 'none';
                document.getElementById('propFields').style.display = mode === 'prop' ? 'block' : 'none';
                
                // Atualizar capital dispon√≠vel ao mudar o modo
                if (mode === 'prop') {
                    const propCapital = parseFloat(document.getElementById('propCapital').value) || 5000;
                    document.getElementById('availableCapital').textContent = formatCurrency(propCapital);
                } else {
                    const personalCapital = parseFloat(document.getElementById('capital').value) || 10000;
                    document.getElementById('availableCapital').textContent = formatCurrency(personalCapital);
                }
                
                updateDashboard();
                updateOperationsTable();
                updateCharts();
            });

            // Adicionar event listener direto para o capital pessoal
            document.getElementById('capital').addEventListener('input', function() {
                if (document.getElementById('modeSelect').value === 'personal') {
                    const value = parseFloat(this.value) || 10000;
                    document.getElementById('availableCapital').textContent = formatCurrency(value);
                }
            });

            // Adicionar event listener direto para o propCapital
            document.getElementById('propCapital').addEventListener('input', function() {
                if (document.getElementById('modeSelect').value === 'prop') {
                    const value = parseFloat(this.value) || 5000;
                    document.getElementById('availableCapital').textContent = formatCurrency(value);
                }
            });

            // Adicionar listener para o bot√£o de apagar selecionados
            document.querySelector('.table-actions .delete-button').addEventListener('click', function() {
                resetMessages();
            });
        }

        // Inicializar o dashboard quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando dashboard...');
            
            // For√ßar modo propriet√°rio como padr√£o
            document.getElementById('modeSelect').value = 'prop';
            
            // Esconder campos pessoais e mostrar campos propriet√°rios
            document.getElementById('personalFields').style.display = 'none';
            document.getElementById('propFields').style.display = 'block';
            
            // Definir valores iniciais
            const propCapital = document.getElementById('propCapital').value || '5000';
            document.getElementById('propCapital').value = propCapital;
            document.getElementById('availableCapital').textContent = formatCurrency(parseFloat(propCapital));
            
            // Adicionar event listener direto para o propCapital
            document.getElementById('propCapital').addEventListener('input', function() {
                if (document.getElementById('modeSelect').value === 'prop') {
                    const value = parseFloat(this.value) || 5000;
                    document.getElementById('availableCapital').textContent = formatCurrency(value);
                }
            });

            // Adicionar event listener direto para o capital pessoal
            document.getElementById('capital').addEventListener('input', function() {
                if (document.getElementById('modeSelect').value === 'personal') {
                    const value = parseFloat(this.value) || 10000;
                    document.getElementById('availableCapital').textContent = formatCurrency(value);
                }
            });
            
            // Configurar event listeners
            setupEventListeners();
            
            // Criar gr√°ficos vazios
            createEmptyCharts();
            
            // For√ßar atualiza√ß√£o inicial do dashboard e tabela
            updateDashboard();
            updateOperationsTable();
            updateCharts();
        });

        function clearStorage() {
            if (confirm('Isso ir√° apagar todos os dados salvos. Tem certeza?')) {
                localStorage.clear();
                alert('Dados limpos com sucesso! A p√°gina ser√° recarregada.');
                location.reload();
            }
        }

        function generateTradePDF(index) {
            try {
                // Obter os trades do localStorage
                const trades = JSON.parse(localStorage.getItem('trades') || '[]');
                const trade = trades[index];
                
                if (!trade) {
                    alert('Opera√ß√£o n√£o encontrada.');
                    return;
                }

                // Criar nova inst√¢ncia do jsPDF
                const doc = new jsPDF();
                
                // Configurar fonte e tamanho
                doc.setFontSize(16);
                doc.text('Relat√≥rio de Opera√ß√£o', 105, 20, { align: 'center' });
                
                // Configurar fonte para o conte√∫do
                doc.setFontSize(12);
                
                // Adicionar informa√ß√µes da opera√ß√£o
                const content = [
                    ['Data', formatDate(trade.date)],
                    ['Modo', trade.mode === 'personal' ? 'Conta Pessoal' : 'Mesa Propriet√°ria'],
                    ['Ativo', trade.asset.toUpperCase()],
                    ['Tipo de Opera√ß√£o', getOperationTypeName(trade.operationType)],
                    ['Tipo de An√°lise', getAnalysisTypeName(trade.analysisType)],
                    ['Contratos', trade.contracts.toString()],
                    ['Pre√ßo de Entrada', formatCurrency(trade.entryPrice)],
                    ['Pre√ßo de Sa√≠da', formatCurrency(trade.exitPrice)],
                    ['Resultado', formatCurrency(trade.result)],
                    ['Capital', formatCurrency(trade.capital)],
                    ['Observa√ß√µes', trade.operationNotes || '']
                ];
                
                // Posi√ß√£o inicial
                let y = 40;
                
                // Adicionar cada linha de informa√ß√£o
                content.forEach(([label, value]) => {
                    doc.text(`${label}: ${value}`, 20, y);
                    y += 10;
                });
                
                // Calcular pontos
                const points = trade.points || (trade.operationType === 'buy' 
                    ? (trade.exitPrice - trade.entryPrice)
                    : (trade.entryPrice - trade.exitPrice));
                    
                // Adicionar resultado em pontos
                doc.text(`Resultado em Pontos: ${Math.abs(points)} pts`, 20, y);
                
                // Adicionar data e hora de gera√ß√£o do relat√≥rio
                const now = new Date();
                doc.setFontSize(10);
                doc.text(`Relat√≥rio gerado em: ${now.toLocaleString('pt-BR')}`, 20, 280);
                
                // Salvar o PDF
                const fileName = `operacao_${trade.asset}_${trade.date}.pdf`;
                doc.save(fileName);
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar o PDF. Por favor, tente novamente.');
            }
        }

        // Fun√ß√£o de an√°lise de pre√ßo atualizada
        function analyzePriceRegion() {
            try {
                const price = parseFloat(document.getElementById('priceSearch').value);
                const asset = document.getElementById('assetSearch').value.toUpperCase();
                const resultDiv = document.getElementById('priceAnalysisResult');

                if (!price || !asset) {
                    alert('Por favor, preencha o pre√ßo e o ativo para an√°lise.');
                    return;
                }

                // Carregar todas as opera√ß√µes
                const trades = JSON.parse(localStorage.getItem('trades') || '[]');
                
                // Filtrar opera√ß√µes pelo ativo e pre√ßo exato
                const exactTrades = trades.filter(trade => 
                    trade.asset.toUpperCase() === asset && 
                    trade.entryPrice === price
                );

                if (exactTrades.length === 0) {
                    resultDiv.innerHTML = `
                        <div style="background-color: #fff3cd; color: #856404; padding: 15px; border-radius: 4px;">
                            Nenhuma opera√ß√£o encontrada neste pre√ßo exato para o ativo ${asset}.
                        </div>
                    `;
                    return;
                }

                // Contar opera√ß√µes por tipo
                const buys = exactTrades.filter(t => t.operationType === 'buy').length;
                const sells = exactTrades.filter(t => t.operationType === 'sell').length;
                const total = exactTrades.length;

                // Calcular resultados m√©dios
                const avgResult = exactTrades.reduce((sum, t) => sum + t.result, 0) / total;
                
                // Determinar tend√™ncia predominante
                let tendency = '';
                let tendencyColor = '';
                if (buys > sells) {
                    tendency = `Voc√™ teve tend√™ncia de COMPRA neste pre√ßo (${buys} compras vs ${sells} vendas)`;
                    tendencyColor = '#4CAF50';
                } else if (sells > buys) {
                    tendency = `Voc√™ teve tend√™ncia de VENDA neste pre√ßo (${sells} vendas vs ${buys} compras)`;
                    tendencyColor = '#f44336';
                } else if (buys === sells && total > 0) {
                    tendency = `Voc√™ operou igualmente comprado e vendido neste pre√ßo (${buys} opera√ß√µes de cada)`;
                    tendencyColor = '#2196F3';
                }

                // Calcular resultado total e m√©dio
                const totalResult = exactTrades.reduce((sum, t) => sum + t.result, 0);
                const successfulTrades = exactTrades.filter(t => t.result > 0).length;
                const winRate = ((successfulTrades / total) * 100).toFixed(2);

                // Formatar resultado
                resultDiv.innerHTML = `
                    <div style="background-color: #fff; padding: 15px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="color: ${tendencyColor}; margin-bottom: 10px;">${tendency}</h4>
                        <div style="margin-top: 15px;">
                            <p><strong>Estat√≠sticas no pre√ßo ${formatCurrency(price)}:</strong></p>
                            <ul style="list-style: none; padding-left: 0; margin-top: 10px;">
                                <li>üìä Total de opera√ß√µes: ${total}</li>
                                <li>üí∞ Resultado total: ${formatCurrency(totalResult)}</li>
                                <li>üìà M√©dia por opera√ß√£o: ${formatCurrency(avgResult)}</li>
                                <li>üéØ Taxa de acerto: ${winRate}%</li>
                                <li>üîÑ Distribui√ß√£o:
                                    <ul style="list-style: none; padding-left: 20px; margin-top: 5px;">
                                        <li style="color: #4CAF50;">‚ÜóÔ∏è Compras: ${buys}</li>
                                        <li style="color: #f44336;">‚ÜòÔ∏è Vendas: ${sells}</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Erro na an√°lise de pre√ßo:', error);
                alert('Erro ao analisar o pre√ßo. Por favor, tente novamente.');
            }
        }
    </script>
</body>
</html> 